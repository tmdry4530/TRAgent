# AI 트레이딩 에이전트 설계 문서

## 개요

바이낸스 기반 BTC 자동매매 에이전트. 룰 기반 시그널 생성 + LLM 컨텍스트 판단 하이브리드 구조.

---

## 1. 데이터 수집

### TIER 1: 필수 (바이낸스 무료)

| 데이터 | 소스 | 엔드포인트 | 주기 |
|--------|------|------------|------|
| 가격 OHLCV | Binance WebSocket | `wss://fstream.binance.com/ws/btcusdt@kline_1m` | 실시간 |
| 오더북 | Binance WebSocket | `wss://fstream.binance.com/ws/btcusdt@depth20@100ms` | 실시간 |
| 체결 데이터 | Binance WebSocket | `wss://fstream.binance.com/ws/btcusdt@aggTrade` | 실시간 |
| 펀딩비 | Binance REST | `/fapi/v1/fundingRate` | 1분 |
| 미결제약정 | Binance REST | `/fapi/v1/openInterest` | 1분 |
| 청산 데이터 | Binance WebSocket | `wss://fstream.binance.com/ws/btcusdt@forceOrder` | 실시간 |
| 롱숏 비율 | Binance REST | `/futures/data/globalLongShortAccountRatio` | 1분 |

### TIER 2: 매크로/스윙 (무료)

| 데이터 | 소스 | 방식 | 주기 |
|--------|------|------|------|
| 경제 캘린더 | Investing.com | 스크래핑 | 1시간 |
| FOMC/CPI/NFP 일정 | FRED API | REST | 1시간 |
| DXY | Yahoo Finance | yfinance | 5분 |
| S&P 500, 나스닥 | Yahoo Finance | yfinance | 5분 |
| 미국채 금리 | FRED API | REST | 5분 |
| Fear & Greed Index | Alternative.me | REST | 1시간 |
| ETF 플로우 | SoSoValue | 스크래핑 | 1시간 |

### TIER 3: 뉴스/센티먼트 (무료)

| 데이터 | 소스 | 제한 |
|--------|------|------|
| 크립토 뉴스 | CryptoPanic API | 분당 5회 |
| 고래 알림 | Whale Alert API | 분당 10회 |
| 트위터 속보 | Nitter 스크래핑 | 불안정 |
| 토큰 언락 | TokenUnlocks | 스크래핑 |

### 추후 추가: Coinglass ($29/월)

- 전체 거래소 합산 OI
- 전체 거래소 합산 청산
- 합산 펀딩비

---

## 2. 데이터 스키마

```python
from dataclasses import dataclass
from datetime import datetime

@dataclass
class MarketState:
    timestamp: datetime
    price: float
    ohlcv_1m: dict
    ohlcv_15m: dict
    orderbook: dict          # {"bids": [...], "asks": [...]}
    funding_rate: float
    open_interest: float
    long_short_ratio: float
    recent_liquidations: list

@dataclass
class MacroContext:
    timestamp: datetime
    fear_greed_index: int
    dxy: float
    sp500_change: float
    nasdaq_change: float
    us10y_yield: float
    upcoming_events: list    # 24시간 내 이벤트
    etf_flow_daily: float

@dataclass
class NewsEvent:
    timestamp: datetime
    source: str
    title: str
    summary: str
    sentiment: str           # LLM 분석 결과
    impact_score: int        # 1-10
    requires_action: bool

@dataclass
class AgentInput:
    market: MarketState
    macro: MacroContext
    recent_news: list[NewsEvent]
    active_positions: list
    account_balance: float
```

---

## 3. 에이전트 아키텍처

### 구조: 하이브리드 (룰 + LLM)

```
┌──────────────────────────────────────────────────────┐
│                   Data Collectors                    │
│  실시간 가격/오더북/청산 + 매크로 + 뉴스              │
└────────────────────────┬─────────────────────────────┘
                         │
                         ▼
┌──────────────────────────────────────────────────────┐
│              Rule-based Signal Engine                │
│                                                      │
│  단타 시그널:                                         │
│  - 청산 캐스케이드 ($50M+)                           │
│  - 펀딩비 극단값 (±0.08%)                            │
│  - 거래량 돌파 (평균 3배)                            │
│                                                      │
│  스윙 시그널:                                        │
│  - EMA 7/25/99 정배열/역배열                         │
│  - RSI 40~60 구간                                   │
│  - Fear & Greed 극단값                               │
└────────────────────────┬─────────────────────────────┘
                         │ 시그널 발생
                         ▼
┌──────────────────────────────────────────────────────┐
│                 LLM Context Filter                   │
│                                                      │
│  입력: 시그널 + 최근 뉴스 + 매크로 상태               │
│  출력: { 실행여부, 확신도, 포지션크기, 이유 }         │
└────────────────────────┬─────────────────────────────┘
                         │ 실행 결정
                         ▼
┌──────────────────────────────────────────────────────┐
│              Risk Manager (룰 강제)                  │
│                                                      │
│  - 최대 포지션 제한                                  │
│  - 손절 강제                                         │
│  - 이벤트 전 진입 금지                               │
└────────────────────────┬─────────────────────────────┘
                         │
                         ▼
┌──────────────────────────────────────────────────────┐
│                    Executor                          │
│            바이낸스 Futures API 주문                 │
└──────────────────────────────────────────────────────┘
```

### 설계 결정

| 항목 | 결정 | 이유 |
|------|------|------|
| LLM 역할 | 하이브리드 | 룰로 속도 + LLM으로 컨텍스트 판단 |
| 에이전트 구조 | 단일 | MVP에서 멀티는 오버엔지니어링 |
| 단타-스윙 | 통합 | 포지션 충돌 방지 |

---

## 4. 트레이딩 전략

### 단타 전략 (1분~1시간)

| 시그널 | 방향 | 조건 | 액션 |
|--------|------|------|------|
| 청산 캐스케이드 | 역추세 | $50M+ 청산 | 반대 포지션 진입 |
| 펀딩비 극단값 | 역추세 | ±0.08% 이상 | 반대 포지션 진입 |
| 거래량 돌파 | 추세 | 평균 3배 + 가격 돌파 | 방향 따라 진입 |

### 스윙 전략 (4시간~일봉)

| 조건 | 롱 | 숏 |
|------|----|----|
| EMA | 7 > 25 > 99 정배열 | 7 < 25 < 99 역배열 |
| RSI (14) | 40~60 구간 진입 | 40~60 구간 진입 |
| Fear & Greed | < 70 | > 30 |

### 포지션 운영

| 구분 | 단타 | 스윙 |
|------|------|------|
| 포지션 크기 | 계좌 20~30% | 계좌 40~50% |
| 레버리지 | 20~40배 | 5~10배 |
| 손절 | 1.5% | 5% |
| 익절 | 3~5% | 15~25% |
| 트레일링 | X | O (고점 대비 7%) |

---

## 5. 리스크 관리

### 포지션 한도

| 항목 | 설정 |
|------|------|
| 단타 최대 포지션 | 계좌 30% |
| 스윙 최대 포지션 | 계좌 50% |
| 총 노출 한도 | 계좌 80% |
| 동시 포지션 | 단타 1 + 스윙 1 (같은 방향만) |

### 손절/익절

| 구분 | 단타 | 스윙 |
|------|------|------|
| 손절 | 1.5% | 5% |
| 익절 | 3~5% | 15~25% |
| 트레일링 스탑 | 없음 | 고점 대비 7% 이탈 |

### 자동 보호 규칙

| 상황 | 대응 |
|------|------|
| 일일 손실 10% 도달 | 당일 거래 중단 |
| 연속 3회 손절 | 1시간 쿨다운 |
| FOMC/CPI 30분 전 | 신규 진입 금지 |
| LLM 확신도 60% 미만 | 포지션 50% 축소 |

---

## 6. 인프라

### 구성

```
┌─────────────────────────────────────────┐
│              VPS ($10~20/월)            │
├─────────────────────────────────────────┤
│  Python 에이전트                         │
│  ├─ Redis (실시간 데이터 캐시)           │
│  └─ SQLite (거래 기록, 히스토리)         │
└─────────────────────────────────────────┘
```

### 기술 스택

| 용도 | 선택 | 이유 |
|------|------|------|
| 실시간 캐시 | Redis | 오더북, 최근 데이터 빠른 접근 |
| 히스토리 DB | SQLite | MVP에 충분, 나중에 교체 가능 |
| 실행 환경 | VPS | 24시간 안정 운영 |
| 메시지 큐 | 생략 | 단일 프로세스로 시작 |

---

## 7. 백테스팅

### 방식

| 단계 | 방식 |
|------|------|
| MVP | 벡터 백테스트 (pandas) |
| 고도화 | 자체 구현 이벤트 기반 |

### 검증 기간

- 1년 (최근 상승장/하락장 포함)

### 핵심 성과 지표

| 지표 | 설명 | 목표 |
|------|------|------|
| 승률 | 이긴 거래 비율 | > 45% |
| 손익비 | 평균 이익 / 평균 손실 | > 1.5 |
| MDD | 최대 낙폭 | < 20% |

### 백테스팅 플로우

```
1. 바이낸스 과거 데이터 수집 (1년치)
2. 시그널 생성 로직 적용
3. 가상 매매 시뮬레이션
4. 성과 지표 계산
5. 전략 파라미터 튜닝
```

---

## 8. 구현 우선순위

### Phase 1: MVP

1. 바이낸스 WebSocket 연결 (가격, 오더북, 청산)
2. 룰 기반 시그널 엔진
3. 기본 리스크 관리
4. 백테스팅 프레임워크
5. 페이퍼 트레이딩

### Phase 2: LLM 통합

1. Claude API 연동
2. 뉴스 수집 파이프라인
3. LLM 컨텍스트 필터
4. 매크로 데이터 연동

### Phase 3: 고도화

1. Coinglass 연동
2. 멀티 코인 확장
3. 성과 대시보드
4. 알림 시스템 (텔레그램)

---

## 9. 이벤트 대응 매트릭스

| 이벤트 | 단타 대응 | 스윙 대응 |
|--------|-----------|-----------|
| FOMC 발표 30분 전 | 포지션 청산 | 레버리지 축소 |
| CPI 발표 직후 | 변동성 스캘핑 | 방향 확인 후 진입 |
| 대량 청산 ($100M+) | 반대매매 진입 | 추세 확인 |
| ETF 대량 유입 | - | 롱 바이어스 |
| 고래 거래소 입금 | 숏 준비 | 익절 준비 |
| 펀딩비 0.1%+ | 숏 바이어스 | 과열 경고 |

---

## 10. 예상 비용

| 항목 | 월 비용 |
|------|---------|
| VPS | $10~20 |
| Claude API | $10~30 (사용량 따라) |
| Coinglass (선택) | $29 |
| **합계** | $20~80 |

---

*문서 작성일: 2025-12-20*
